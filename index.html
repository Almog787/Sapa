<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מערכת ניתוח תיק השקעות - שקלים</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #3b82f6; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        .val { font-size: 1.8rem; font-weight: bold; margin-top: 10px; }
        .label { color: #94a3b8; font-size: 0.9rem; }
        .chart-container { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #334155; }
        th { background: #334155; }
        .pos { color: #10b981; } .neg { color: #f43f5e; }
        .usd-info { font-size: 0.8rem; color: #64748b; margin-top: 5px; }
    </style>
</head>
<body>

    <h2 id="mainTitle">טוען נתונים מה-Data Hub...</h2>

    <div class="grid">
        <div class="card">
            <div class="label">שווי תיק נוכחי (ILS)</div>
            <div id="totalVal" class="val">₪0</div>
            <div id="usdExchangeInfo" class="usd-info">טוען שער חליפין...</div>
        </div>
        <div class="card">
            <div class="label">תשואה מצטברת (דולרי)</div>
            <div id="totalRet" class="val">0%</div>
        </div>
        <div class="card">
            <div class="label">Max Drawdown</div>
            <div id="maxDD" class="val neg">0%</div>
        </div>
        <div class="card">
            <div class="label">המניה המנצחת</div>
            <div id="bestStock" class="val pos">-</div>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="mainChart" height="100"></canvas>
    </div>

    <table>
        <thead>
            <tr>
                <th>נכס</th>
                <th>כמות</th>
                <th>מחיר ($)</th>
                <th>שווי (₪)</th>
                <th>משקל</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

<script>
    // פונקציה למשיכת שער דולר עדכני
    async function getUsdRate() {
        try {
            const res = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/ILS=X');
            const data = await res.json();
            return data.chart.result[0].meta.regularMarketPrice;
        } catch (e) {
            console.error("נכשל במשיכת שער דולר, משתמש בברירת מחדל");
            return 3.65; // שער גיבוי
        }
    }

    async function fetchData() {
        try {
            const usdRate = await getUsdRate();
            document.getElementById('usdExchangeInfo').innerText = `שער דולר נוכחי: ₪${usdRate.toFixed(3)}`;

            const [history, portfolio] = await Promise.all([
                fetch('data_hub/stock_history.json').then(r => r.json()),
                fetch('data_hub/portfolio.json').then(r => r.json())
            ]);

            const tickers = Object.keys(portfolio);
            const last = history[history.length - 1];
            const first = history[0];

            const calcValueUSD = (data) => tickers.reduce((sum, t) => sum + (data.prices[t] * portfolio[t] || 0), 0);

            // 1. שווי בשקלים ותשואה
            const currentValUSD = calcValueUSD(last);
            const initialValUSD = calcValueUSD(first);
            const currentValILS = currentValUSD * usdRate;
            const totalReturn = ((currentValUSD / initialValUSD) - 1) * 100;

            document.getElementById('mainTitle').innerText = `ניתוח תיק - ${last.timestamp}`;
            document.getElementById('totalVal').innerText = `₪${currentValILS.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            document.getElementById('totalRet').innerText = `${totalReturn.toFixed(2)}%`;
            document.getElementById('totalRet').classList.add(totalReturn >= 0 ? 'pos' : 'neg');

            // 2. חישוב Max Drawdown (מבוסס שווי דולרי למניעת רעש של שער חליפין)
            let peakUSD = 0;
            let mdd = 0;
            history.forEach(h => {
                const v = calcValueUSD(h);
                if (v > peakUSD) peakUSD = v;
                const dd = (v / peakUSD) - 1;
                if (dd < mdd) mdd = dd;
            });
            document.getElementById('maxDD').innerText = `${(mdd * 100).toFixed(2)}%`;

            // 3. מציאת המניה הטובה ביותר
            let bestStock = '';
            let bestPerf = -Infinity;
            tickers.forEach(t => {
                const p = ((last.prices[t] / first.prices[t]) - 1) * 100;
                if (p > bestPerf) { bestPerf = p; bestStock = t; }
            });
            document.getElementById('bestStock').innerText = `${bestStock} (+${bestPerf.toFixed(1)}%)`;

            // 4. בניית הטבלה בשקלים
            document.getElementById('tableBody').innerHTML = tickers.map(t => {
                const posValueILS = last.prices[t] * portfolio[t] * usdRate;
                return `
                <tr>
                    <td><b>${t}</b></td>
                    <td>${portfolio[t]}</td>
                    <td>$${last.prices[t].toLocaleString()}</td>
                    <td>₪${posValueILS.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td>${((last.prices[t] * portfolio[t] / currentValUSD) * 100).toFixed(1)}%</td>
                </tr>`;
            }).join('');

            // 5. גרף ביצועים מנורמל
            new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: {
                    labels: history.map(h => h.timestamp.split(' ')[0]),
                    datasets: [{
                        label: 'ביצועי התיק (%)',
                        data: history.map(h => (calcValueUSD(h) / initialValUSD * 100).toFixed(2)),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } } }
                }
            });

        } catch (err) {
            document.getElementById('mainTitle').innerText = "שגיאה בטעינת הנתונים מה-Data Hub";
            console.error(err);
        }
    }
    fetchData();
</script>
</body>
</html>
